---
title: "Assignment 4"
author: "Juntong Wei, Qin Xu, Xuanming Liang, Ziang Li"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, 
                      messages = FALSE, 
                      warning = FALSE)
```

```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(dplyr)
library(broom)
library(countrycode)
library(tidytext)
library(viridis)
library(rworldmap)
library(ggmap)
library(maps)
library(sp)
library(maptools)
library(readr)
library(ggraph)
library(igraph)
library(RColorBrewer)
library(gganimate)
library(gifski)
library(ggalluvial)
library(hrbrthemes)
library(kableExtra)
library(leaflet)
library (scales)
library (shiny)
library(ggalluvial)
```

```{r}
data <- read_csv("data/athlete_events.csv")
dat1 <- read_csv("data/countries.csv")
```

<<<<<<< HEAD

\Section*{1}
**Medal distribution by country**

```{r}
medal <- data %>%
  filter(!is.na(Medal))

team<- medal %>% 
  group_by(NOC) %>% 
  summarise(Gold =  sum (Medal == "Gold"),
            Silver = sum (Medal == "Silver"),
            Bronze = sum (Medal == "Bronze"))
```

```{r}
team_M <- team %>%
  pivot_longer(!"NOC", names_to = "medals", values_to = "number_of_medals")

country_M <- countrycode(team_M$NOC, "ioc", "country.name")

country_M <- data_frame(country_M, team_M)
country_M<- na.omit(country_M)
```

```{r}
team_T <- cbind(team, c(rowSums(team [, 2:4], na.rm = TRUE))) 
colnames(team_T)[5] <- "Total"

country_T <- countrycode(team_T$NOC, "ioc", "country.name")

country_T <- data_frame(country_T, team_T)
country_T<- na.omit(country_T)

country_T <- country_T %>%
  arrange(desc(Total)) %>% 
  rename("Country" = country_T)

country_T_10 <- country_T%>% 
  top_n(10)

knitr::kable(country_T_10, caption = "The medals in different country", col.names = c("Country",  "NOC", "Gold", "Silver", "Bronze", "Total"))
```

```{r}
ct <- inner_join(country_T, dat1, by = "Country")
```

```{r}
world <- map_data("world")
visit.x<-ct$Longitude
visit.y<-ct$Latitude
```

```{r}
hex_codes <- hue_pal(h=c(180,270)) (length(ct$Country)) 
pal <- colorFactor(hex_codes, domain = ct$Country)

mytext <- paste(
   "Country: ", ct$Country, 
   "Total: ", ct$Total, 
   "Gold: ", ct$Gold,
   "Silver: ", ct$Silver,
   "Bronze: ", ct$Bronze) %>%
  lapply(htmltools::HTML)

map <- leaflet(ct) %>% 
  addTiles() %>%
  addCircles(
    lng = ~Longitude,
    lat = ~Latitude,
    radius = ~Total*300,
    stroke = F,
    fillOpacity = 0.4,
    color = ~pal(Country),
    label = mytext
  ) %>%
  addLegend ("topright", 
             pal=pal, 
             values = ~Country,
             title = "Country",
             opacity = 1
  )

map
```

The map shows the number of medals won by each country in the world at the Olympic Games, including gold, silver, bronze and total. The size of the circles on the map indicates the number of medals won, so it is easy to see that the USA has the most medals. Europe has the highest number of medals, and the density of the circles shows that most European countries have won medals and have accumulated a significant number of medals in total.



\Section*{2}
**Find out which sport has the largest number of participants and study the distribution of gold MEDALS in different countries over time**

```{r}
sport_count<- data %>% 
  mutate(Number_of_people_in_each_sport = Sport) %>% 
  count(Number_of_people_in_each_sport) %>% 
  top_n(10) 
```

```{r wei1, fig.cap="Top 10 sports with the most athletes", fig.align='center'}
sport_count %>% 
  mutate(Number_of_people_in_each_sport = fct_reorder(Number_of_people_in_each_sport, n)) %>% 
  ggplot(aes(x = Number_of_people_in_each_sport, 
             y = n, 
             fill = Number_of_people_in_each_sport)) + 
  coord_flip() + 
  geom_text(aes(x = Number_of_people_in_each_sport,  
                y = n + 4000,
                label = n)) + 
  geom_col() + 
  xlab("Sport") +
  ylab("Number of people in each sport") + 
  theme(strip.text = element_text(size = 10), 
        axis.text = element_text(size = 10), 
        axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 0.15),
        axis.title.x = element_text(size = 15), 
        axis.title.y = element_text(size = 15))
```

With the Figure \@ref(fig:wei1), It illustrate the number of participants in different sports, and select the top 10 of them, according to the figure, the most popular sports is **Athletics** which is 38,624. the second is **gymnastics** and the third one is **swimming**. the fine thing about this figure is that the number of participate athletes of first 3 sport is far more than any other sports. 

```{r}
Athletics_1 <- data %>% 
  filter(Sport == "Athletics" & Medal == "Gold")%>% 
  select(Sport, NOC, Medal, Year) %>% 
  cbind(1) %>% 
  rename("Number" = "1") %>% 
  group_by(NOC, Year) %>%
  summarise(Total = sum(Number)) %>% 
  mutate(Accumu = cumsum(Total)) 

Athletics <- inner_join(Athletics_1, country_T, by="NOC")
```

```{r}
ranking <- Athletics %>%
  group_by(Year) %>%
  mutate(rank = rank(-Accumu),
         Accumu_rel = Accumu/Accumu[rank==1],
         Accumu_lbl = paste0(" ",round(Accumu/1e9))) %>%
  group_by(Country) %>% 
  filter(rank <=5) %>%
  ungroup()
```

```{r wei2, fig.cap="In the Athletics sports, the ranking of first 5 contries about Total number of Cumulative gold MEDALS won ", fig.align='center'}
ggp <- ggplot(ranking, 
              aes(x = rank, 
                  y = Accumu, 
                  group = Country)) +
  geom_bar(stat = "identity", 
           aes(fill = Country)) +
  transition_states(Year, transition_length = 2, state_length = 0) + 
  ease_aes('quadratic-in-out') +  
  enter_drift(x_mod = -1) + exit_drift(x_mod = 1) +
  labs(x = "Ranking of the gold medal accumulated",
       y = "Accumulated Number of gold medal",
       title = "Year {closest_state}")

animate(ggp, 200, fps = 20,  width = 1200, height = 1000, 
        renderer = gifski_renderer("gganim.gif"))
```

Then we focus on the athletics sports, the above Figure \@ref(fig:wei2) describes only in the Athletics sports, it shows number of Cumulative gold MEDALS won in each country and ranking them. The x-axis is about first 5 ranking, the y-axis is about the Accumulated Number of gold medal, and the different color means different countries, so there are 2 interesting finding in this GIF, 

- The American is always number one in the ranking list except year 1980. That's because the USA did not join the sport meet in that year to boycott the former Soviet Union. 

- Sometimes the bar overlapped on the x-axis, which means it shares the same ranking place in this year. 

## How about the Medals of top 5 countries allocated in the events (Ziang_Li)

```{r}
top1 <- country_T %>%
  top_n(5)

aa <- sport_count %>% 
  arrange(desc(n)) %>% 
  top_n(5)

ttt <- top1 %>% 
  inner_join(data, top1, by="NOC") %>% 
  filter (!is.na (Medal)) %>% 
  filter ( Sport == "Athletics" | Sport == "Gymnastics" | Sport == "Swimming" | Sport == "Shooting" | Sport == "Cycling") %>% 
  select (Country, Sport, Event, Medal) %>% 
  group_by(Country, Sport, Event, Medal) %>% 
  tally() %>% 
  ungroup() %>% 
  group_by(Country, Sport, Event) %>% 
  summarise( n = sum(n)) 

Athletics <- ttt %>% 
  ungroup() %>% 
  filter(Sport == "Athletics") %>% 
  group_by(Event) %>% 
  summarise( tot = sum(n)) %>% 
  arrange(desc(tot)) %>% 
  top_n(5)

Cycling <- ttt %>% 
  ungroup() %>% 
  filter(Sport == "Cycling") %>% 
  group_by(Event) %>% 
  summarise( tot = sum(n)) %>% 
  arrange(desc(tot)) %>% 
  top_n(5)

Gymnastics <- ttt %>% 
  ungroup() %>% 
  filter(Sport == "Gymnastics") %>% 
  group_by(Event) %>% 
  summarise( tot = sum(n)) %>% 
  arrange(desc(tot)) %>% 
  top_n(5)

Shooting <- ttt %>% 
  ungroup() %>% 
  filter(Sport == "Shooting") %>% 
  group_by(Event) %>% 
  summarise( tot = sum(n)) %>% 
  arrange(desc(tot)) %>% 
  top_n(5)

Swimming <- ttt %>% 
  ungroup() %>% 
  filter(Sport == "Swimming") %>% 
  group_by(Event) %>% 
  summarise( tot = sum(n)) %>% 
  arrange(desc(tot)) %>% 
  top_n(5)

rrr <- rbind(Athletics, Cycling, Gymnastics, Shooting, Swimming) 

ooo <- left_join(rrr, ttt, by="Event") 

```

```{r, fig.height=15, fig.width=20}
ggplot(as.data.frame(ooo),
       aes(y = n, axis1 = Country, axis2 = Sport, axis3 = Event)) +
  geom_alluvium(aes(fill = Country), width = 1/40) +
  geom_stratum(width = 1/50, fill = "white", color = "black") +
  geom_label(stat = "stratum", aes(label = after_stat(stratum)))+
  scale_x_discrete(limits = c("Country", "Sport", "Event"), expand = c(.05, .05)) +
  scale_fill_brewer(type = "qual", palette = "Set3") +
  ggtitle("Distribution of the top 5 Countries' medals among the 5 sports with the most participants")
```

```{r}
qqq <- data %>% 
  filter(!is.na(Medal)) %>%
  select (NOC, Year, Medal)%>% 
  cbind (1) %>% 
  rename( "Number" = "1") %>% 
  select(NOC, Year, Number) 

qqq <- left_join(qqq, country_T) 

www <- qqq %>% 
  select(Country, Year, Number) %>% 
  group_by(Country, Year) %>% 
  summarise( number = sum(Number)) %>% 
  mutate(total = cumsum(number)) %>% 
  filter(Country == "United States" | Country == "Germany" | Country == "United Kingdom" | Country == "France" | Country == "Italy")

```

```{r}
q <- ggplot(www, aes(x=Year, y=total, group=Country, color=Country)) +
    geom_line() +
    geom_point() +
    scale_color_viridis(discrete = TRUE) +
    ggtitle("Changes in the total number of medals of the top 5 countries in the previous Olympic Games") +
    theme_ipsum() +
    ylab("Number of the medals") +
    transition_reveal(Year)

animate(q, nframes = 350,fps = 25,  width = 1200, height = 1000, 
        renderer = gifski_renderer("yearly.gif"))
```

